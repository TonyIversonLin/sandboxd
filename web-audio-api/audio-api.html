<!DOCTYPE html>
<html>
<head>
	<title>Web Audio Api - Basic Drum Pattern</title>
</head>
<body>
	<button id='playSong' disabled>Play</button>
	<script type="text/javascript" src='init.js'></script>
	<script type="text/javascript" src='BufferLoader.js'></script>
	<script type="text/javascript">

		let context = init();
		BufferLoader(context,[
			'resource/instrument1.mp3',
			'resource/instrument2.mp3',
			'resource/instrument3.mp3'])
		.then(play);

		function play(buffers){
			let button = document.getElementById('playSong');
			button.disabled = false;
			button.onclick = function(){
				playSong(buffers);
			}
		}

		function playSong(buffers){
			beat1 = buffers[0];
			beat2 = buffers[1];
			beat3 = buffers[2];

			let eightNoteTime = 0.3;
			let startTime = context.currentTime;

			for(let bar = 0; bar<2; bar++){
				let time = startTime + bar * 8 * eightNoteTime;

				playSound(beat1, time);
				playSound(beat1, time + 4 * eightNoteTime);

				playSound(beat2, time + 2 * eightNoteTime);
				playSound(beat2, time + 6 * eightNoteTime);

				for(let i=0; i<8; ++i){
					playSound(beat3, time + i * eightNoteTime);
				}
			}
		}

		function playSound(buffer, time){
			let source = context.createBufferSource();
			source.buffer = buffer;
			source.connect(context.destination);
			source.start(time);
		}

	</script>
</body>
</html>