<!DOCTYPE html>
<html>
<head>
	<title>Web Audio Api - Basic Drum Pattern</title>
</head>
<body>
	<p>Simple drum beats <button id='beats' disabled>Play</button></p>
	<p>Cross fading <button id='crossfade' disabled>Play</button></p>
	<script type="text/javascript" src='init.js'></script>
	<script type="text/javascript" src='BufferLoader.js'></script>
	<script type="text/javascript">

		let context = init();
		BufferLoader(context,[
			'resource/instrument1.mp3',
			'resource/instrument2.mp3',
			'resource/instrument3.mp3',
			'resource/crossfading1.mp3',
			'resource/crossfading2.mp3'])
		.then(play);

		function play(buffers){
			let buttons = document.getElementsByTagName('button');
			for(let i=0;i<buttons.length;i++) buttons[i].disabled = false; 

			let beatPattern = document.getElementById('beats');
			beatPattern.onclick = function(){
				playSong(buffers);
			}

			let crossfading = document.getElementById('crossfade');
			crossfading.onclick = function(){
				playCrossFade([buffers[3],buffers[4]],2,0.5);
			}
		}

		function playSong(buffers){
			beat1 = buffers[0];
			beat2 = buffers[1];
			beat3 = buffers[2];

			let eightNoteTime = 0.3;
			let startTime = context.currentTime;

			for(let bar = 0; bar<2; bar++){
				let time = startTime + bar * 8 * eightNoteTime;

				playSound(beat1, time);
				playSound(beat1, time + 4 * eightNoteTime);

				playSound(beat2, time + 2 * eightNoteTime);
				playSound(beat2, time + 6 * eightNoteTime);

				for(let i=0; i<8; ++i){
					playSound(beat3, time + i * eightNoteTime);
				}
			}
		}

		function playSound(buffer, time){
			let source = context.createBufferSource();
			source.buffer = buffer;
			source.connect(context.destination);
			source.start(time);
		}

		function playCrossFade(buffers, iterations, fadeTime) {
			let currTime = context.currentTime;
			for(let i=0;i<iterations;i++){
				for(let j=0;j<buffers.length;j++){
					let buffer = buffers[j];
					let duration = buffer.duration;
					let info = createSourceWithGain(buffer);
					let source = info.source;
					let gainNode = info.gainNode;

					gainNode.gain.linearRampToValueAtTime(0,currTime);
					gainNode.gain.linearRampToValueAtTime(1,currTime+fadeTime);
					gainNode.gain.linearRampToValueAtTime(1,currTime+duration-fadeTime);
					gainNode.gain.linearRampToValueAtTime(0,currTime+duration);

					source.start(currTime);
					currTime += duration-fadeTime;
				}
			}
		}

		function createSourceWithGain(buffer){
			let source = context.createBufferSource();
			let gainNode = context.createGain();
			source.buffer = buffer;
			source.connect(gainNode);
			gainNode.connect(context.destination);

			return {
				source: source,
				gainNode: gainNode
			}
		}

	</script>
</body>
</html>